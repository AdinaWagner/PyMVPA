#!/usr/bin/make -f
# -*- mode: makefile; coding: utf-8 -*-

srcpkg = $(shell LC_ALL=C dpkg-parsechangelog | grep '^Source:' | cut -d ' ' -f 2,2)
# this figures out the last merge point from 'master' into the 'dist' branch and
# then described this commit relative to the last release tag (upstream/...)
# If this should make any sense the local master branch must track remote
# master.
gitver = $(shell [ -x /usr/bin/git ] && git describe --tags --match 'upstream/*' $$(git merge-base -a HEAD master) | sed -e 's,^upstream/,,' -e 's/\.dev/~dev/')


include /usr/share/cdbs/1/rules/debhelper.mk
DEB_PYTHON_SYSTEM = pysupport
# for earlier cdbs versions
DEB_PYTHON_MODULE_PACKAGE = python-mvpa-snapshot
# for cdbs >= 0.4.54
DEB_PYTHON_MODULE_PACKAGES = python-mvpa-snapshot python-mvpa-snapshot-lib
include /usr/share/cdbs/1/class/python-distutils.mk

# enable the LIBSVM wrapper
DEB_PYTHON_BUILD_ARGS += --with-libsvm
DEB_PYTHON_INSTALL_ARGS_ALL += --with-libsvm

clean::
	$(MAKE) distclean

# run at install otherwise at build it tends to do them twice for some
# reason
install/python-mvpa-snapshot::
ifeq (,$(filter nocheck,$(DEB_BUILD_OPTIONS)))
	for buildver in $(shell pyversions -vr); do \
		echo "I: Running PyMVPA unittests using python$$buildver"; \
		cd $(CURDIR) && cd $(DEB_SRCDIR)/build/lib.*-$$buildver && \
		ln -s $(CURDIR)/mvpa/data mvpa/ && \
		MVPA_TESTS_LOWMEM=yes MVPA_TESTS_QUICK=yes MVPA_TESTS_LABILE=no PYTHONPATH=. \
		$(call cdbs_python_binary,python$$buildver) mvpa/tests/main.py \
		|| exit 1 ; [ -d mvpa/data ] && rm mvpa/data; \
	done
endif

install/python-mvpa-snapshot-lib::
	# move libraries into the python-mvpa-snapshot-lib package
	for lib in $$(find debian/python-mvpa-snapshot/usr -name '*.so'); do \
	   sdir=$$(dirname $$lib) ; \
	   tdir=debian/python-mvpa-snapshot-lib/$${sdir#*python-mvpa-snapshot/} ; \
	   mkdir -p $$tdir ; \
	   echo "Moving '$$lib' into '$$tdir'." ; \
	   mv $$lib $$tdir ; \
	done

# we need to move libraries away first, hence dependence on -lib
# Also without this step, movemodules from pysupport would not
# move arch-indep part of the module under pyshared
install/python-mvpa-snapshot:: install/python-mvpa-snapshot-lib

binary-install/python-mvpa-snapshot-lib::
	# assure that there is no mvpa module itself
	# actually remove everything under ../share/.. since that is provided
	# by python-mvpa. That prevents e.g. duplicate egg-info files.
#	rm -rf debian/python-mvpa-lib/usr/share/python-support/python-mvpa-lib/*

# install directly into package directory (despite multiple packages)
DEB_DESTDIR = $(CURDIR)/debian/python-mvpa-snapshot


# make orig tarball from repository content
get-orig-source:
	# orig tarball, turn directory into something nicer
	git archive --format=tar --prefix=$(srcpkg)-$(gitver)/ HEAD | \
		gzip -9 > $(srcpkg)_$(gitver).orig.tar.gz

